{% extends "_layout.njk" %}

{% block style %}
<style>
  .uk-divider-icon + h2 {
    margin-top: 0;
  }

  /* Обернем кнопку Telegram в блок с отступами и inline-block для корректного размера */
  .telegram-login-wrapper {
    display: inline-block;
    margin-bottom: 1rem;
  }
</style>
{% endblock %}

{% block content %}

  {% if authError %}
    <div class="uk-alert uk-alert-danger">
      <p>{{ authError }}</p>
    </div>
  {% endif %}

  <h2>Войти</h2>
  <form method="POST" action="/login" enctype="application/x-www-form-urlencoded">
    <p><input type="text" name="username" class="uk-input"></p>
    <p><input type="password" name="password" class="uk-input"></p>
    <p><button class="uk-button uk-button-primary">Вход</button></p>
  </form>

  <hr class="uk-divider-icon" />

  <h2>Зарегистрироваться</h2>
  <form method="POST" action="/signup" enctype="application/x-www-form-urlencoded">
    <p><input type="text" name="username" class="uk-input"></p>
    <p><input type="password" name="password" class="uk-input"></p>
    <p><button class="uk-button uk-button-primary">Создать аккаунт</button></p>
  </form>

  <hr class="uk-divider-icon" />

  <h2>Войти через соцсети</h2>

  <p uk-margin>
    <a class="uk-button uk-button-secondary uk-button-large" href="/auth/google">
      <i class="fab fa-google"></i>&nbsp;Google
    </a>
  </p>

  <p uk-margin>
    <a class="uk-button uk-button-secondary uk-button-large" href="/auth/github">
      <i class="fab fa-github"></i>&nbsp;GitHub
    </a>
  </p>

  <p uk-margin>
  <script async src="https://telegram.org/js/telegram-widget.js?22"
    data-telegram-login="NoteLoginBot"
    data-size="large"
    data-userpic="false"
    data-request-access="write"
    data-onauth="onTelegramAuth(user)">
  </script>
</p>

<script>
  async function onTelegramAuth(user) {
    console.log('Telegram user:', user);

    const response = await fetch('/auth/telegram', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(user),
    });

    if (response.ok) {
      window.location.href = '/dashboard';
    } else {
      alert('Ошибка авторизации через Telegram');
    }
  }
</script>

{% endblock %}
